<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Respiratory Registration | Frederik Hartmann</title> <meta name="author" content="Frederik Hartmann"> <meta name="description" content="Image registration of chest CT volumes; 4DCT DIR-Lab Challenge"> <meta name="keywords" content="Frederik, Hartmann"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://frederik-hartmann.github.io/projects/respiratoryRegistration/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Frederik </span>Hartmann</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Respiratory Registration</h1> <p class="post-description">Image registration of chest CT volumes; 4DCT DIR-Lab Challenge</p> </header> <article> <hr> <p>Authors: <a href="https://github.com/Frederik-Hartmann" rel="external nofollow noopener" target="_blank">Frederik Hartmann</a>, <a href="https://xavibeltranurbano.github.io/" rel="external nofollow noopener" target="_blank">Xavier Beltran Urbano</a> <br> Code: <a href="https://github.com/Frederik-Hartmann/4DCT_DIR-Lab_Challenge" rel="external nofollow noopener" target="_blank">Github</a> <br> Report: <a href="https://github.com/Frederik-Hartmann/4DCT_DIR-Lab_Challenge/blob/main/Manuscript/Report.pdf" rel="external nofollow noopener" target="_blank">Github</a></p> <p><em>This project was carried out within the scope of the Medical Image Registration course taught by <a href="https://scholar.google.com/citations?user=M_sM6x8AAAAJ&amp;hl=en" rel="external nofollow noopener" target="_blank">Prof. Dr. Robert Martí</a>. You can reach a detailed report <a href="">here</a>.</em></p> <p>December 2023</p> <hr> <hr> <h2 id="dataset">Dataset</h2> <p>To implement this project we have utilized a data set consisting of 4 thoracic 4DCT images acquired at the University of Texas M. D. Anderson Cancer Center in Houston TX. Each CT image in the dataset corresponds to different respiratory-binned phases ranging from T00 to T90. The T00 phase represented end-inhalation while the T50 phase represented end-exhalation. Expert manual annotation was conducted to identify 300 landmarks on each patient’s CT images of T00 and T50. In the Figure 1 we can observe an example of the inhalation and exhalation phases of patient 1 with their corresponding landmarks.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/respiratoryRegistration/Dataset-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/respiratoryRegistration/Dataset-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/respiratoryRegistration/Dataset-1400.webp"></source> <img src="/assets/projectImages/respiratoryRegistration/Dataset.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="Example of the 4DCT DIR-LAB Dataset" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> An illustration of the respiratory phases in the COPD1 case. A) Inhalation phase with highlighted landmarks (red points). B) Exhalation phase, also featuring corresponding landmarks (red points).</div> <h2 id="methodology">Methodology</h2> <p>Our approach can be divided into 2 sections:</p> <h3 id="-preprocessing">· Preprocessing</h3> <p>Three preprocessing techniques have been employed and tested (see Fig. 2):</p> <ol> <li> <p><strong>Segmentation:</strong> Two approaches were tested. The first approach relied on classical image processing techniques, focusing on the intensity range and position of the lung. It involved coarse segmentation to remove the table, contour tracking for refinement, and post-processing to close holes. The second approach used a pretrained UNet model, trained on various datasets for lung segmentation.</p> </li> <li> <p><strong>Normalization:</strong> After segmentation, min-max normalization was applied using the formula:</p> </li> </ol> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/respiratoryRegistration/Normalization_Equation-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/respiratoryRegistration/Normalization_Equation-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/respiratoryRegistration/Normalization_Equation-1400.webp"></source> <img src="/assets/projectImages/respiratoryRegistration/Normalization_Equation.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="Example of the Normalization formula" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <ol> <li> <strong>Histogram Equalization:</strong> Contrast-limited adaptive histogram equalization (CLAHE) was applied to each axial slice.</li> </ol> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/respiratoryRegistration/Preprocessing-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/respiratoryRegistration/Preprocessing-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/respiratoryRegistration/Preprocessing-1400.webp"></source> <img src="/assets/projectImages/respiratoryRegistration/Preprocessing.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="Example of the preprocessing employed" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Sequential overview of preprocessing steps in this approach. A) Original image B) Segmented Image C) Normalized and contrast-enhanced (CLAHE) image.</div> <h3 id="-training">· Training</h3> <ol> <li> <p><strong>Registration-Elastix:</strong> This method included an affine transformation and a bspline registration for non-rigid transformations. A custom parameter set adapted for the challenge was used.</p> </li> <li> <p><strong>Registration-VoxelMorph:</strong> A deep learning approach using a U-Net architecture, the ‘VxmDense’ model in TensorFlow, was implemented. The model was trained over 100 epochs, combining Mean Squared Error (MSE) and a gradient loss in the loss function.</p> </li> </ol> <h2 id="results">Results</h2> <p>Both quantitative and qualitative results are presented in this section.</p> <h3 id="-quantitative-results">· Quantitative Results</h3> <table border="1" align="center"> <caption><em>Table 1: Results of the registration comparing different approaches. ¹: Bspline file 1 and 2; ²: Bspline file 1</em></caption> <tr> <th>Parameter File</th> <th>Affine</th> <th>Bspline</th> <th>Segmentation</th> <th>CLAHE</th> <th>Time (min)</th> <th>COPD1</th> <th>COPD2</th> <th>COPD3</th> <th>COPD4</th> <th>Mean</th> <th>Std</th> </tr> <tr> <td>No Registration</td> <td>-</td> <td>-</td> <td>-</td> <td>✓</td> <td>0:36</td> <td>-</td> <td>26.33</td> <td>21.79</td> <td>12.64</td> <td>29.58</td> <td>22.59</td> <td>6.38</td> </tr> <tr> <td>Par11</td> <td>✓</td> <td>-</td> <td>-</td> <td>-</td> <td>0:34 ± 0:04</td> <td>25.98</td> <td>26.26</td> <td>7.50</td> <td>25.75</td> <td>21.38</td> <td>8.01</td> </tr> <tr> <td>Par11</td> <td>✓</td> <td>✓</td> <td>-</td> <td>-</td> <td>0:51 ± 0:11</td> <td>25.37</td> <td>26.03</td> <td>7.56</td> <td>23.02</td> <td>20.50</td> <td>7.55</td> </tr> <tr> <td>Par11</td> <td>✓</td> <td>✓</td> <td>✓</td> <td>-</td> <td>0:40 ± 0:15</td> <td>15.12</td> <td>14.68</td> <td>5.63</td> <td>12.90</td> <td>12.08</td> <td>3.82</td> </tr> <tr> <td>Par11</td> <td>✓</td> <td>✓</td> <td>✓</td> <td>✓</td> <td>10:07 ± 3:24</td> <td>14.16</td> <td>12.84</td> <td>4.87</td> <td>10.16</td> <td>10.51</td> <td>3.56</td> </tr> <tr> <td>Par11</td> <td>✓</td> <td>✓¹</td> <td>-</td> <td>✓</td> <td>23:43 ± 5:58</td> <td>6.88</td> <td>6.73</td> <td>1.90</td> <td>10.91</td> <td>6.60</td> <td>3.19</td> </tr> <tr> <td>Par11</td> <td>✓</td> <td>✓²</td> <td>✓</td> <td>✓</td> <td>-</td> <td>8.11</td> <td>7.75</td> <td>2.36</td> <td>10.07</td> <td>7.07</td> <td>2.86</td> </tr> <tr> <td>custom</td> <td>✓</td> <td>-</td> <td>✓</td> <td>-</td> <td>1:25 ± 0:24</td> <td>14.17</td> <td>12.88</td> <td>4.79</td> <td>10.18</td> <td>10.50</td> <td>3.60</td> </tr> <tr> <td>custom</td> <td>✓</td> <td>✓</td> <td>✓</td> <td>-</td> <td>4:39 ± 0:33</td> <td>2.39</td> <td>5.60</td> <td>1.95</td> <td>3.71</td> <td>3.41</td> <td>1.42</td> </tr> <tr> <td>custom</td> <td>✓</td> <td>✓</td> <td>✓</td> <td>✓</td> <td>4:57 ± 0:48</td> <td>1.39</td> <td>4.86</td> <td>1.34</td> <td>2.63</td> <td>2.55</td> <td>1.43</td> </tr> <tr> <td>Voxelmorph</td> <td>-</td> <td>-</td> <td>✓</td> <td>✓</td> <td>46:37 ± 5:12</td> <td>39.76</td> <td>11.28</td> <td>31.50</td> <td>33.12</td> <td>28.92</td> <td>10.53</td> </tr> </table> <h3 id="-qualitative-results">· Qualitative Results</h3> <p>The image below showcases the outcomes of the final registration for each method employed in this project, providing a visual comparison of their performance:</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/respiratoryRegistration/Results-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/respiratoryRegistration/Results-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/respiratoryRegistration/Results-1400.webp"></source> <img src="/assets/projectImages/respiratoryRegistration/Results.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="Results" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Example of the registration obtained with the different approaches implemented in this project. A) Moving Image B) Fixed Image C) Affine + Normalization + CLAHE, D) Only Affine, E) Affine + Segmentation + Normalization + CLAHE, F) Affine + Segmentation , G) Affine + Bspline set 1 + Bspline set 2 + Segmentation + Normalization + CLAHE, H) Affine + Bspline set 1 + Segmentation + Normalization + CLAHE, I) Custom parameter set affine only, J) Custom parameter set affine + Bspline + Segmentation, K) Custom parameter set affine + Segmentation, L) Voxelmorph .</div> <h2 id="conclusion">Conclusion</h2> <p>In conclusion, the variety of methods tested led to several findings:</p> <ol> <li>Classical approaches can still outperform deep learning methods if fine-tuned properly.</li> <li>Normalization and contrast enhancement did not lead to improved results but rather worse ones.</li> <li>Segmentation improved results significantly by targeting registration only at relevant regions.</li> <li>The parameter set choice was crucial, with improvements observed when adapting it for the dataset’s specific requirements.</li> </ol> </article> </div> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Frederik Hartmann. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>