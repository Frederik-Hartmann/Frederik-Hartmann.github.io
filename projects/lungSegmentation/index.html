<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Lung Segmentation | Frederik Hartmann</title> <meta name="author" content="Frederik Hartmann"> <meta name="description" content="Three-Dimensional Lung Segmentation from CT Scans"> <meta name="keywords" content="Frederik, Hartmann"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://frederik-hartmann.github.io/projects/lungSegmentation/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Frederik </span>Hartmann</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Lung Segmentation</h1> <p class="post-description">Three-Dimensional Lung Segmentation from CT Scans</p> </header> <article> <h1 id="lung-segmentation-in-3d-computed-tomography-scans">Lung segmentation in 3D computed tomography scans</h1> <hr> <p>Authors: <a href="https://github.com/Frederik-Hartmann" rel="external nofollow noopener" target="_blank">Frederik Hartmann</a>, <a href="https://www.github.com/yusuftengriverdi" rel="external nofollow noopener" target="_blank">Yusuf Baran Tanrıverdi</a> <br> Code: <a href="https://github.com/Frederik-Hartmann/3DLungSegmentation" rel="external nofollow noopener" target="_blank">Github</a></p> <p><em>This project was carried out within the scope of the Advanced Image Analysis course taught by <a href="https://www.unicas.it/didattica/docenti/teacherinfo.aspx?nome_cognome=alessandro_bria" rel="external nofollow noopener" target="_blank">Prof. Alessandro Bria</a>. The project was awarded with the best project award 2023. You can reach the more carefully worded report <a href="https://yusuftengriverdi.github.io/blog/2023/04/15/lung_segmentation_3d" rel="external nofollow noopener" target="_blank">here</a>. Scroll down for a beginner-friendly guide.</em></p> <p>April 2023</p> <hr> <h1 id="a-detailed-tutorial">A detailed tutorial</h1> <p>In this tutorial, it is explained how to segment a lung in a 3D CT scan. First, let’s take a look at a CT scan.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/CTScan-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/CTScan-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/CTScan-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/CTScan.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="CTScan" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>In the picture above, you can vaguely outline the body, head, and arms of the person. Below the person, a table on which the person is lying can be spotted. It is worth mentioning that the table is not broken, and the gaps are due to the display technique used. Now let’s take a look at an axial slice in the centre.</p> <div class="row justify-content-center align-items-center"> <div class="col-sm mt-3 mt-md-0 d-flex justify-content-center align-items-center"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/AxialSlice-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/AxialSlice-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/AxialSlice-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/AxialSlice.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="CTScan" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>In this image, the lung is displayed in the dark. The surrounding tissues and bones appear brighter. The background has roughly the same intensity as the lung tissue. At the bottom of the picture, multiple lines can be seen. These lines are the edges of the patient table and what appears to be a cushion. The goal of lung segmentation is to find or segment the lung. In order to accomplish this, the table, background, and surrounding tissues need to be removed. In the following, all steps will be explained in detail with text, pictures, and code.</p> <h2 id="preprocessing">Preprocessing</h2> <p>The first step is preprocessing. The goal is to remove the table and make the background have the same intensity as the tissue surrounding the lung. Each pixel or cell in a computed tomography scan is not encoded in a range from 0-255 (8-bit unsigned), but rather in a range from −32,768 to 32,767 (16-bit signed). However, there is more to it. Each value represents a Hounsfield unit (HU), and Hounsfield units can be attributed to a specific tissue. Because we are only interested in lung tissue, we choose a range in which the lung is safely included and set all other pixels to the maximum of the range. In this case, a range of -1000 HU to -500 HU.</p> <div class="row justify-content-sm-center"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/AxialSlice-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/AxialSlice-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/AxialSlice-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/AxialSlice.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="AxialSlice" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/clippedAxialSlice-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/clippedAxialSlice-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/clippedAxialSlice-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/clippedAxialSlice.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="clippedAxialSlice" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">clipScanToHounsfieldUnitRange</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span><span class="n">HounsfieldUnitRange</span><span class="p">):</span>
	<span class="n">HU_min</span> <span class="o">=</span> <span class="n">HounsfieldUnitRange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">HU_max</span> <span class="o">=</span> <span class="n">HounsfieldUnitRange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
	<span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span><span class="n">a_min</span><span class="o">=</span><span class="n">HU_min</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">HU_max</span><span class="p">)</span>
</code></pre></div></div> <p>This is done for the entire scan. The steps after this are applied to each slice separately. It can be seen that the table in this viewing direction is not a straight line. This will become important later. To make the table straight, we use the sagittal view and therefore use sagittal slices. First we loop through the sagittal slices:</p> <div class="row justify-content-center align-items-center"> <div class="col-sm mt-3 mt-md-0 d-flex justify-content-center align-items-center"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/AxialSlice-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/AxialSlice-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/AxialSlice-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/AxialSlice.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="AxialSlice" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">createMaskForEachSliceOf</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">clippedScan</span><span class="p">):</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">clippedScan</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="sh">"</span><span class="s">int16</span><span class="sh">"</span><span class="p">)</span>
	<span class="n">numberOfSagittalSlices</span> <span class="o">=</span> <span class="n">clippedScan</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">numberOfSagittalSlices</span><span class="p">):</span>
			<span class="n">sagittalSlice</span> <span class="o">=</span> <span class="n">clippedScan</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
			<span class="n">sliceMask</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">createMaskFrom</span><span class="p">(</span><span class="n">sagittalSlice</span><span class="p">)</span>
			<span class="n">mask</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sliceMask</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="sh">"</span><span class="s">int16</span><span class="sh">"</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">mask</span>
</code></pre></div></div> <p>The next step is to create a mask for each sagittal slice. Each function will be explained in the following steps.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">createMaskFrom</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">SagittalSlice</span><span class="p">):</span>
        <span class="n">denoisedSagittalSlice</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">medianBlur</span><span class="p">(</span><span class="n">SagittalSlice</span><span class="p">,</span><span class="n">ksize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">binarizedSagittalSlice</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">binarize</span><span class="p">(</span><span class="n">denoisedSagittalSlice</span><span class="p">)</span>
        <span class="n">sliceWithOpenTable</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">openTableOf</span><span class="p">(</span><span class="n">binarizedSagittalSlice</span><span class="p">)</span>
        <span class="n">SagittalSliceWithUniformBackground</span><span class="p">,</span> <span class="n">backgroundMask</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">createUniformBackgroundOf</span><span class="p">(</span><span class="n">binarizedSagittalSlice</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">createMaskByFillingHolesOf</span><span class="p">(</span><span class="n">SagittalSliceWithUniformBackground</span><span class="p">)</span>
        <span class="n">combinedMask</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">combineMasks</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">backgroundMask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">combinedMask</span>
</code></pre></div></div> <p>Let’s start with the denoising. It is worth noting that denoising might remove relevant medical information. However, some scans can be a bit noisy. The type of noise seems to be “salt” and “pepper” noise. To reduce this kind of noise, one can apply median filtering. Let’s zoom in on our slice and apply denoising. To the left, you can see the background with some clothes; in the middle, the tissues surrounding the lung; and on the right, the lung. You can see that the noise has been reduced, but at the same time, the slice appears to be more blurry.</p> <div class="row justify-content-sm-center"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/noisySagittalSlice-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/noisySagittalSlice-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/noisySagittalSlice-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/noisySagittalSlice.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="noisySagittalSlice" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/denoisedSagittalSlice-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/denoisedSagittalSlice-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/denoisedSagittalSlice-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/denoisedSagittalSlice.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="denoisedSagittalSlice" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>In order to create the mask, we have to binarize the image. The binarization is achieved by thresholding the image with a threshold of the maximum value minus one.</p> <div class="row justify-content-sm-center"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/denoisedFullSagittalSlice-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/denoisedFullSagittalSlice-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/denoisedFullSagittalSlice-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/denoisedFullSagittalSlice.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="denoisedFullSagittalSlice" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/binarizedSagittalSlice-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/binarizedSagittalSlice-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/binarizedSagittalSlice-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/binarizedSagittalSlice.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="binarizedSagittalSlice" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">binarize</span><span class="p">(</span><span class="n">sagittalSlice</span><span class="p">):</span>
	<span class="n">_</span><span class="p">,</span> <span class="n">binarizedSlice</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">threshold</span><span class="p">(</span><span class="n">sagittalSlice</span><span class="p">,</span>
	    	<span class="n">thresh</span><span class="o">=</span><span class="n">sagittalSlice</span><span class="p">.</span><span class="nf">max</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
	    	<span class="nb">type</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">binarizedSlice</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="sh">"</span><span class="s">uint8</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <p>The next goal is to make everything that is not lung tissue white. In order to accomplish this, we will flood the image from the left and right. We could also flood it from the top and bottom, but in case the lung is touching the border, it will flood it to zero. However, a problem remains. When flooding from the right, it is impossible to flow through the table. So we need to break the table first. We do that on the top row of the image only. We use morphological openings to open the table. The structuring element is a line. The line needs to be longer than the table width. The result is displayed below.</p> <div class="row justify-content-sm-center"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/tableClosed-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/tableClosed-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/tableClosed-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/tableClosed.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="tableClosed" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/tableOpen-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/tableOpen-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/tableOpen-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/tableOpen.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="tableOpen" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">openTableOf</span><span class="p">(</span><span class="n">binarizedSagittalSlice</span><span class="p">):</span>
  <span class="n">kernel</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">getStructuringElement</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">MORPH_RECT</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
  <span class="n">topRowOpen</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">morphologyEx</span><span class="p">(</span><span class="n">binarizedSagittalSlice</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">cv2</span><span class="p">.</span><span class="n">MORPH_OPEN</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">binarizedSagittalSlice</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">topRowOpen</span>
  <span class="k">return</span> <span class="n">binarizedSagittalSlice</span><span class="p">)</span>
</code></pre></div></div> <p>Now we floodfill the binarized image from left to right. In addition to that, we will receive a map of where the floodfilling was applied. We call this mask a background mask. Floodfilling only accepts a single pixel as an input. Since we want to flood from the entire edge, we draw a line in the colour of the background there.</p> <div class="row justify-content-sm-center"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/tableOpenFull-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/tableOpenFull-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/tableOpenFull-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/tableOpenFull.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="tableOpenFull" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/floodedSagittalSlice-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/floodedSagittalSlice-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/floodedSagittalSlice-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/floodedSagittalSlice.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="floodedSagittalSlice" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">createUniformBackgroundOf</span><span class="p">(</span><span class="n">binarizedSagittalSlice</span><span class="p">):</span>
  <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">binarizedSagittalSlice</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
  <span class="n">backgroundMask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">h</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">w</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="sh">"</span><span class="s">uint8</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">cv2</span><span class="p">.</span><span class="nf">line</span><span class="p">(</span><span class="n">binarizedSagittalSlice</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">thickness</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
  <span class="n">cv2</span><span class="p">.</span><span class="nf">line</span><span class="p">(</span><span class="n">binarizedSagittalSlice</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">thickness</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
  <span class="n">cv2</span><span class="p">.</span><span class="nf">floodFill</span><span class="p">(</span><span class="n">binarizedSagittalSlice</span><span class="p">,</span> <span class="n">backgroundMask</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="n">flags</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> 
  <span class="n">cv2</span><span class="p">.</span><span class="nf">floodFill</span><span class="p">(</span><span class="n">binarizedSagittalSlice</span><span class="p">,</span> <span class="n">backgroundMask</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="n">flags</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
  <span class="n">backgroundMask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">logical_not</span><span class="p">(</span><span class="n">backgroundMask</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]).</span><span class="nf">astype</span><span class="p">(</span><span class="sh">"</span><span class="s">uint8</span><span class="sh">"</span><span class="p">)</span> 
  <span class="k">return</span> <span class="n">binarizedSagittalSlice</span><span class="p">,</span> <span class="n">backgroundMask</span>
</code></pre></div></div> <p>As you can see, we now have the lung in black on a white background. The goal is to have the lung in white on a black background. Because we will apply the mask to the original image again and refine it, we can now close the holes generously. This is done by applying a box filter of ones with a kernel size of 30. The output of this convolution will not be binary anymore. Therefore, the slice is thresholded again. As you can see, the lung area is covered, but there are some points that clearly aren’t below the lung.</p> <div class="row justify-content-center align-items-center"> <div class="col-sm mt-3 mt-md-0 d-flex justify-content-center align-items-center"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/closedHolesSagittalSlice-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/closedHolesSagittalSlice-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/closedHolesSagittalSlice-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/closedHolesSagittalSlice.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="closedHolesSagittalSlice" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">createMaskByFillingHolesOf</span><span class="p">(</span><span class="n">BinarySliceWithUniformBackground</span><span class="p">):</span>
  <span class="n">inverted</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">logical_not</span><span class="p">(</span><span class="n">BinarySliceWithUniformBackground</span><span class="p">)).</span><span class="nf">astype</span><span class="p">(</span><span class="sh">"</span><span class="s">uint8</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">filled</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">boxFilter</span><span class="p">(</span><span class="n">inverted</span><span class="p">,</span> <span class="n">ddepth</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">),</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">binarized</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">threshold</span><span class="p">(</span><span class="n">filled</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">binarized</span>
</code></pre></div></div> <p>The final step of the preprocessing is the combining of the masks. The creation of the mask in step 7 has caused the mask to grow back in the background. Luckily for us, in step 6, we have created a background mask, so we can just use this one. In the image below, one difference is circled.</p> <div class="row justify-content-center align-items-center"> <div class="col-sm mt-3 mt-md-0 d-flex justify-content-center align-items-center"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/combinedPreMask-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/combinedPreMask-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/combinedPreMask-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/combinedPreMask.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="combinedPreMask" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">combineMasks</span><span class="p">(</span><span class="n">filledMask</span><span class="p">,</span> <span class="n">backgroundMask</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">bitwise_and</span><span class="p">(</span><span class="n">filledMask</span><span class="p">,</span> <span class="n">backgroundMask</span><span class="p">)</span>
</code></pre></div></div> <p>Now let’s put everything together. First, we clip the scan, then we create a mask slice-by-slice by applying the eight steps:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">createCoarseLungMaskOf</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">scan</span><span class="p">):</span>
  <span class="n">HounsfieldUnitRange</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="o">-</span><span class="mi">500</span><span class="p">)</span>
  <span class="n">clippedScan</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">clipScanToHounsfieldUnitRange</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">HounsfieldUnitRange</span><span class="p">)</span>
  <span class="n">mask</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">createMaskForEachSliceOf</span><span class="p">(</span><span class="n">clippedScan</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">mask</span>
</code></pre></div></div> <p>As a reminder, the returned mask is a 3D numpy array. Additionally, all functions have been put into a class.</p> <h3 id="evaluation-of-preprocessing">Evaluation of preprocessing</h3> <p>The goals of the preprocessing were:</p> <ol> <li>Remove the table</li> <li>Make the backgroud and surrounding tissue of the lung the same colour.</li> </ol> <p>Let’s check if the table has been removed:</p> <div class="row justify-content-center align-items-center"> <div class="col-sm mt-3 mt-md-0 d-flex justify-content-center align-items-center"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/preprocessed3D-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/preprocessed3D-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/preprocessed3D-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/preprocessed3D.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="preprocessed3D" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>It can be seen that the table was successfully removed. However, some artefacts remain (circled in red). Additionally, the tube in the middle (circled in blue) is not a part of the lung, but it is part of the airways that provide the lung with air. The tube is called the trachea. We will take care of these problems in the next step, but for now, let’s have a look at the background. It can be seen that the background seems to be the same colour, but did we remove any lung ixels or voxels? For that, we calculate the sensitivity on the vessel12 dataset:</p> \[0.9999694 \pm 0.0000436\] <p>It can be seen that some pixels are wrongly labeled as not lung. Nevertheless, the amount of wrongly labeled pixels is low. Additionally, the region of interest has been reduced from the entire image to a smaller mask. The average relative size is</p> \[\sum Predicted Mask / \sum Actual Mask = 0.1864\] <p>This means that the predicted mask is roughly 81% smaller than the original image.</p> <h2 id="lung-segmentation">Lung Segmentation</h2> <p>In the preprocessing step, we have managed to get a relatively coarse lung mask. Let’s refine this mask. The two main goals are:</p> <ol> <li>Remove the artefacts.</li> <li>Remove the tracha and aerial ways.</li> </ol> <h3 id="loading-the-scan">Loading the scan</h3> <p>Before we get into that, There is one thing we haven’t talked about yet, and that is loading the scan. This step now depends on the data format you are using. If you are using Vessel12, the file ending is <strong>“mhd”</strong>. We can load this file format using SimpleITK. It is worth noting that simpleITK supports a variety of file formats, so just try yours. The “.mhd” file contains meta data and the scan:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 
<span class="k">def</span> <span class="nf">readScanMetaFrom</span><span class="p">(</span><span class="n">scanPath</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">sitk</span><span class="p">.</span><span class="nc">ReadImage</span><span class="p">(</span><span class="n">scanPath</span><span class="p">)</span>
</code></pre></div></div> <p>To get the actual scan without meta data, we can use the following:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">readScanMetaFrom</span><span class="p">(</span><span class="n">scanPath</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">sitk</span><span class="p">.</span><span class="nc">ReadImage</span><span class="p">(</span><span class="n">scanPath</span><span class="p">)</span>
</code></pre></div></div> <p>Now we are good to go. So let’s dive right into it. First, we use preprocessing and apply mask the scan:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 
<span class="n">coarseMask</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">preprocessing</span><span class="p">.</span><span class="nf">createCoarseLungMaskOf</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">scan</span><span class="p">)</span>
<span class="n">coarseScan</span> <span class="o">=</span> <span class="n">coarseMask</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">scan</span>
</code></pre></div></div> <div class="row justify-content-sm-center"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/coarseMask-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/coarseMask-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/coarseMask-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/coarseMask.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="coarseMask" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/coarseMaskApplied-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/coarseMaskApplied-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/coarseMaskApplied-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/coarseMaskApplied.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="coarseMaskApplied" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Remember, we want to refine the mask, right? So let’s create a function for that. The idea is the following: We clip the slice again, search for contours, and decide if these contours are lung or not. We will do this by tracking the contours, but more on that later. The process of deciding if a contour is a lung or not is included in the <em>createFineMaskFrom(…)</em> function.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">refine</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">coarseScan</span><span class="p">):</span>
  <span class="n">HounsfieldUnitRange</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="o">-</span><span class="mi">500</span><span class="p">)</span>
  <span class="n">clippedScan</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">preprocessing</span><span class="p">.</span><span class="nf">clipScanToHounsfieldUnitRange</span><span class="p">(</span><span class="n">coarseScan</span><span class="p">,</span> <span class="n">HounsfieldUnitRange</span><span class="p">)</span>
  <span class="n">contoursForEachAxialSlice</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">findContoursForEachAxialSliceOf</span><span class="p">(</span><span class="n">clippedScan</span><span class="p">)</span>
  <span class="n">fineMask</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">createFineMaskFrom</span><span class="p">(</span><span class="n">contoursForEachAxialSlice</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">fineMask</span>
</code></pre></div></div> <h3 id="finding-contours">Finding Contours</h3> <p>We have covered the clipping in the preprocessing, so the next step is finding the contours. We will search for the contours in the axial slices.</p> <p>Loop through the axial slices:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">findContoursForEachAxialSliceOf</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">clippedScan</span><span class="p">):</span>
  <span class="n">numberOfAxialSlices</span> <span class="o">=</span> <span class="n">clippedScan</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">contoursForEachAxialSlice</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">numberOfAxialSlices</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberOfAxialSlices</span><span class="p">):</span>
      <span class="n">axialSlice</span> <span class="o">=</span> <span class="n">clippedScan</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">sliceContours</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">findContoursOf</span><span class="p">(</span><span class="n">axialSlice</span><span class="p">)</span>
      <span class="n">contoursForEachAxialSlice</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sliceContours</span>
  <span class="k">return</span> <span class="n">contoursForEachAxialSlice</span>
</code></pre></div></div> <p>The second step is to find the contours for each axial slice. We will use OpenCV’s findContours for this. Let’s take a look at what the <a href="https://docs.opencv.org/4.7.0/d3/dc0/group__imgproc__shape.html#gadf1ad6a0b82947fa1fe3c3d497f260e0" rel="external nofollow noopener" target="_blank">documentation</a> is saying about the input image: <em>Source: an 8-bit single-channel image. Non-zero pixels are treated as 1’s. Zero pixels remain 0’s, so the image is treated as “binary.</em> This is important. The input image will be “converted” to binary. Why not make it binary in the way we want it? Another important thing is not explicitly stated: The background is expected to be black and the foreground to be white. Our background is white, and the foreground—the lung—is black. This will cause <em>findContours</em> to find a contour around the entire image. We don’t want that. Summing up, we have three things to consider:</p> <ul> <li>The slice should be binary.</li> <li>The background should be black and the foreground white.</li> <li>The slice should be 8-bit. We will deal with the first two together. First, we denoise the image, and then we threshold the image. This time we use <em>THRESH_BINARY_INV</em> to invert the colors. The lung is now white, and the background is black. After that, we convert the binary image to 8-bit. Let’s take a look at the code and the output image.</li> </ul> <div class="row justify-content-center align-items-center"> <div class="col-sm mt-3 mt-md-0 d-flex justify-content-center align-items-center"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/mainPrepared-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/mainPrepared-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/mainPrepared-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/mainPrepared.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="mainPrepared" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">axialSlice</span><span class="p">):</span>
	<span class="n">denoisedAxialSlice</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">medianBlur</span><span class="p">(</span><span class="n">axialSlice</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
	<span class="n">binarizedAxialSlice</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">binarize</span><span class="p">(</span><span class="n">denoisedAxialSlice</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">binarizedAxialSlice</span>

<span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">binarize</span><span class="p">(</span><span class="n">axialSlice</span><span class="p">):</span>
	<span class="n">_</span><span class="p">,</span> <span class="n">binarizedSlice</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">threshold</span><span class="p">(</span><span class="n">axialSlice</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="n">axialSlice</span><span class="p">.</span><span class="nf">max</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
					<span class="n">maxval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">THRESH_BINARY_INV</span><span class="p">)</span>
  	<span class="k">return</span> <span class="n">binarizedSlice</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="sh">"</span><span class="s">uint8</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <p>Now that we have prepared our slice, it is time to find the contours. But how many lung contours can realistically be in an axial slice? You might think two lungs are two contours. However, this is only the case in three dimensions. The maximum number of lung contours is empirically chosen to be four. We will first look at the code and then at two examples of the contours. Additionally, we use <em>RETR_EXTERNAL</em> to retrieve only the outer contours.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">findContoursOf</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">axialSlice</span><span class="p">):</span>
  <span class="n">preparedSlice</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prepare</span><span class="p">(</span><span class="n">axialSlice</span><span class="p">)</span>
  <span class="n">contours</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">findContours</span><span class="p">(</span><span class="n">preparedSlice</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">CHAIN_APPROX_NONE</span><span class="p">)</span>
  <span class="n">contoursSortedByLength</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">contours</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">contour</span><span class="p">:</span><span class="nf">len</span><span class="p">(</span><span class="n">contour</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">reducedNumberOfContours</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">reduceNumberOf</span><span class="p">(</span><span class="n">contoursSortedByLength</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">reducedNumberOfContours</span>

<span class="k">def</span> <span class="nf">reduceNumberOf</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">contoursSortedByLength</span><span class="p">):</span>
  <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">contoursSortedByLength</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">MAX_NUMBER_OF_CONTOURS_TO_BE_TRACKED</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">contoursSortedByLength</span><span class="p">[:</span><span class="n">self</span><span class="p">.</span><span class="n">MAX_NUMBER_OF_CONTOURS_TO_BE_TRACKED</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">contoursSortedByLength</span>
</code></pre></div></div> <div class="row justify-content-sm-center"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContours-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContours-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContours-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/TwoContours.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="TwoContours" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContours-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContours-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContours-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/ManyContours.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="ManyContours" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>We will take a look at how many contours are correct in the right example later on.</p> <h3 id="tracking-the-contours">Tracking the Contours</h3> <p>We now have a bunch of contours, but which ones are actually lung contours? Which ones are artifacts? Which ones are tracheas? For this, we will track the contours. We start in the centre slice and assume all contours there are lung contours. We now go one slice up and compare the contours to see if they are more or less the same—it is a lung contour too! We now go on to slice up again and compare the contours to the ones in the slice below, and so on. We will do exactly the same from the centre to the bottom; it is just reversed. Let’s get into it.</p> <p>First, we create one model for the top half of the 3D image and one for the bottom half.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">createFineMaskFrom</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">contoursForEachAxialSlice</span><span class="p">):</span>
  <span class="n">refinedBottomMask</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">refineMaskBytrackingLungContours</span><span class="p">(</span><span class="n">contoursForEachAxialSlice</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="sh">"</span><span class="s">centerToTop</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">refinedTopMask</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">refineMaskBytrackingLungContours</span><span class="p">(</span><span class="n">contoursForEachAxialSlice</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="sh">"</span><span class="s">centerToBottom</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">refinedMask</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">addMasks</span><span class="p">(</span><span class="n">refinedBottomMask</span><span class="p">,</span><span class="n">refinedTopMask</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">refinedMask</span>
</code></pre></div></div> <p>Now we cycle through each axial slice contour by contour and compare it to the counters of the previous slice. Don’t worry too much about the code at the top. The important steps are happening in the for loop. For a closer look at the top functions,refer to this <a href="https://github.com/Frederik-Hartmann/3DLungSegmentation/blob/main/lungSegmentation.py" rel="external nofollow noopener" target="_blank">file</a>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">refineMaskBytrackingLungContours</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">contoursForEachAxialSlice</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
  <span class="n">startIndex</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getStartIndex</span><span class="p">(</span><span class="n">contoursForEachAxialSlice</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
  <span class="n">finalIndex</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getFinalIndex</span><span class="p">(</span><span class="n">contoursForEachAxialSlice</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
  <span class="n">stepDirection</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">stepDirectionToInteger</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
  <span class="n">refinedMask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">scanDimensions</span><span class="p">)</span>
  <span class="n">centerContours</span> <span class="o">=</span> <span class="n">contoursForEachAxialSlice</span><span class="p">[</span><span class="n">startIndex</span><span class="p">]</span>
  <span class="n">previousMasks</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getCandidateMasksFrom</span><span class="p">(</span><span class="n">centerContours</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">startIndex</span><span class="p">,</span> <span class="n">finalIndex</span><span class="p">,</span> <span class="n">stepDirection</span><span class="p">):</span>
	<span class="n">CurrentContours</span> <span class="o">=</span> <span class="n">contoursForEachAxialSlice</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
	<span class="n">lungMasks</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">comparePreviousMasksToCurrentContours</span><span class="p">(</span><span class="n">previousMasks</span><span class="p">,</span><span class="n">CurrentContours</span><span class="p">)</span>
	<span class="n">lungMask</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">createSingleMaskFrom</span><span class="p">(</span><span class="n">lungMasks</span><span class="p">)</span>
	<span class="n">refinedMask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lungMask</span>
	<span class="n">previousMasks</span> <span class="o">=</span> <span class="n">lungMasks</span>
  <span class="k">return</span> <span class="n">refinedMask</span>
</code></pre></div></div> <p>For the comparison, we will need a mask rather than a contour. <em>getCandidateMasksFrom</em> is doing just that. We will have a look at it next, also with pictures. After that, we compare every current mask to the masks from the previous slice. Once we have found a match, we assume it is a lung mask. We will not quit the search for this current mask and continue with the next one. If no match is found, we assume it is not a lung. We will also have a close look at <em>isLungMask</em> and how we decide if it’s a lung mask or not, but first we look at <em>getCandidateMasksFrom</em>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">comparePreviousMasksToCurrentContours</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">previousMasks</span><span class="p">,</span><span class="n">CurrentContours</span><span class="p">):</span>
  <span class="n">candidateMasks</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getCandidateMasksFrom</span><span class="p">(</span><span class="n">CurrentContours</span><span class="p">)</span>
  <span class="n">lungMasks</span> <span class="o">=</span> <span class="p">[</span>
  <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">candidateMasks</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">prevMask</span> <span class="ow">in</span> <span class="n">previousMasks</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">isLungMask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">prevMask</span><span class="p">):</span>
        <span class="n">lungMasks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">break</span> <span class="c1"># breaks inner loop
</span>  
  <span class="k">return</span> <span class="n">lungMasks</span>
</code></pre></div></div> <p>Let us quickly have a look at the code before we look at some pictures. The idea is simple: We create one mask for each contour.&lt;p</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">getCandidateMasksFrom</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">CurrentContours</span><span class="p">):</span>
  <span class="n">numberOfContours</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">CurrentContours</span><span class="p">)</span>
  <span class="n">candidateMasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">numberOfContours</span>
  <span class="n">sliceDimensions</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">scanDimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">numberOfContours</span><span class="p">):</span>
    <span class="n">candidateMask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">sliceDimensions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="sh">"</span><span class="s">uint8</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="nf">drawContours</span><span class="p">(</span><span class="n">candidateMask</span><span class="p">,</span> <span class="p">[</span><span class="n">CurrentContours</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">contourIdx</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">FILLED</span><span class="p">)</span>
    <span class="n">candidateMasks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidateMask</span>
  <span class="k">return</span> <span class="n">candidateMasks</span>
</code></pre></div></div> <p>And finally some pictures:</p> <div class="row justify-content-sm-center"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContours-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContours-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContours-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/TwoContours.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="TwoContours" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursContour0-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursContour0-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursContour0-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/TwoContoursContour0.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="TwoContoursContour0" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursContour1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursContour1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursContour1-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/TwoContoursContour1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="TwoContoursContour1" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> All contours (left), mask for counter 1 (middle) and mask for contour 2 (right). </div> <p>And even more. Remember, we chose the maximum number of contours at four. The tradeoff here is runtime vs. accuracy. The more contours, the higher the runtime, and the higher the accuracy.</p> <div class="row justify-content-center align-items-center"> <div class="col-sm mt-3 mt-md-0 d-flex justify-content-center align-items-center"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContours-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContours-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContours-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/ManyContours.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="ManyContours" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> All contours. </div> <div class="row justify-content-sm-center"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursContour0-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursContour0-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursContour0-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/ManyContoursContour0.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="ManyContoursContour0" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursContour1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursContour1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursContour1-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/ManyContoursContour1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="ManyContoursContour1" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursContour2-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursContour2-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursContour2-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/ManyContoursContour2.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="ManyContoursContour2" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursContour3-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursContour3-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursContour3-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/ManyContoursContour3.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="ManyContoursContour3" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Mask for counter 1 (left), mask for contour 2 (2nd left), mask for contour 3 (3rd left) and mask for contour 4 (right). </div> <p>For the comparison, we look at the two Jaccard scores. It accounts for the overlap (intersection) and the union of the current mask and the preceding mask. Instead of the combination, the difference is displayed for visualisation purposes.</p> <div class="row justify-content-sm-center"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursTrackingContour0-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursTrackingContour0-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursTrackingContour0-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/TwoContoursTrackingContour0.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="TwoContoursTrackingContour0" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursTrackingContour1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursTrackingContour1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursTrackingContour1-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/TwoContoursTrackingContour1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="TwoContoursTrackingContour1" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Comparison contour 1 (left) and comparison contour 2 (right). </div> <div class="row justify-content-sm-center"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour0-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour0-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour0-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour0.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="ManyContoursTrackingContour0" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour1-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="ManyContoursTrackingContour1" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour2-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour2-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour2-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour2.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="ManyContoursTrackingContour2" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour3-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour3-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour3-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/ManyContoursTrackingContour3.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="ManyContoursTrackingContour3" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Comparison contour 1 (left), comparison contour 2 (2nd left), comparison contour 3 (3rd left) and comparison contour 4 (right). </div> <p>You can see that all comparisons look relatively good. Sure, some differences are a bit bigger and some are a bit smaller, but nonetheless, the difference doesn’t seem that big. So are all of the masks displayed here a lung contour? The answer is shockingly no, because each contour has to be continuously tracked from the centre slice. In the next steps, we will take a look at the decision-making process and the results of the tracking.</p> <p>For the decision-making process, three cases are considered:</p> <ol> <li> <strong>Normal case</strong>: The contour got slightly bigger or smaller.</li> <li> <strong>Splitting Case</strong>: One contour split into two contours</li> <li> <strong>Merging Case</strong>: Two contours merged into one contour Let’s put that into code: <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">isLungMask</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span> <span class="n">prevMask</span><span class="p">):</span>
  <span class="n">jaccardScore</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">computeJaccardScore</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">prevMask</span><span class="p">)</span>
  <span class="n">currentSize</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">countNonZero</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
  <span class="n">prevSize</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">countNonZero</span><span class="p">(</span><span class="n">prevMask</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">isMaskOverlapping</span><span class="p">(</span><span class="n">jaccardScore</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span>
  <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="nf">isMaskSplittedIntoTwoMasks</span><span class="p">(</span><span class="n">jaccardScorecurrentSize</span><span class="p">,</span> <span class="n">prevSize</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span>
  <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="nf">isMaskMergedFromTwoMasks</span><span class="p">(</span><span class="n">jaccardScorecurrentSize</span><span class="p">,</span> <span class="n">prevSize</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">False</span>
</code></pre></div> </div> </li> </ol> <p>Now we need to define each case. But before we do that, let’s look at the Jaccard score:</p> <p>\begin{equation} jaccard score = intersection / union \end{equation}</p> <p>We can compute the intersection using an <strong>AND</strong> Gate, the union using an <strong>OR</strong> Gate;</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">computeJaccardScore</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">prevMask</span><span class="p">):</span>
  <span class="n">intersection</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">countNonZero</span><span class="p">(</span><span class="n">cv2</span><span class="p">.</span><span class="nf">bitwise_and</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">prevMask</span><span class="p">))</span>
  <span class="n">union</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">countNonZero</span><span class="p">(</span><span class="n">cv2</span><span class="p">.</span><span class="nf">bitwise_or</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">prevMask</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">union</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">intersection</span><span class="o">/</span><span class="n">union</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="mf">1.0</span>
</code></pre></div></div> <p>Now we can define each case. In the first case, if the Jaccard score is higher than the threshold, which has been set to 0.1, we assume it’s a lung mask.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">isMaskOverlapping</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">jaccardScore</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">jaccardScore</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">JACCARD_THRESHOLD</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">True</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div> <p>The second case can happen if the two lungs are detected as one contour and then detected as two contours in the next slice. In this case, we assume that the contour is now roughly half as big. The merging is practically the same, but in reverse: two masks merged into one.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">isMaskSplittedIntoTwoMasks</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">jaccardScore</span><span class="p">,</span> <span class="n">currentSize</span><span class="p">,</span> <span class="n">prevSize</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">jaccardScore</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">JACCARD_THRESHOLD</span><span class="o">/</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">np</span><span class="p">.</span><span class="nf">isclose</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">currentSize</span><span class="p">,</span> <span class="n">prevSize</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">isMaskMergedFromTwoMasks</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">jaccardScore</span><span class="p">,</span> <span class="n">currentSize</span><span class="p">,</span> <span class="n">prevSize</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">jaccardScore</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">JACCARD_THRESHOLD</span><span class="o">/</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">np</span><span class="p">.</span><span class="nf">isclose</span><span class="p">(</span><span class="n">currentSize</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">prevSize</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div> <p>This is an image of an actual splitting case. It is worth noting that the merging case would look the same because we are only displaying the difference and not which slice is the current or previous one. You can see that the lung in the previous slice was one cotour. Now there are two.</p> <div class="row justify-content-center align-items-center"> <div class="col-sm mt-3 mt-md-0 d-flex justify-content-center align-items-center"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/MaskSplitting-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/MaskSplitting-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/MaskSplitting-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/MaskSplitting.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="MaskSplitting" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h3 id="a-small-evaluation">A small Evaluation</h3> <p>Remember the picture with a lot of contours? No? No problem. Here it is again:</p> <div class="row justify-content-center align-items-center"> <div class="col-sm mt-3 mt-md-0 d-flex justify-content-center align-items-center"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContours-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContours-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContours-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/ManyContours.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="ManyContours" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Can you guess which ones are lung contours? Let’s take a look at what our tracking predicts:</p> <div class="row justify-content-center align-items-center"> <div class="col-sm mt-3 mt-md-0 d-flex justify-content-center align-items-center"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursPrediction-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursPrediction-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursPrediction-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/ManyContoursPrediction.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="ManyContoursPrediction" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Our tracking presumes the three at the bottom to be lung contours. But is that correct? At the time of writing, I don’t actually know the answer. Let’s compare it to the ground truth to find out.</p> <div class="row justify-content-center align-items-center"> <div class="col-sm mt-3 mt-md-0 d-flex justify-content-center align-items-center"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursComparison-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursComparison-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/ManyContoursComparison-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/ManyContoursComparison.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="ManyContoursComparison" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>The green part is where our prediction is correct, and the red part has missing pixels. All in all, our tracking was correct, and we identified the three contours correctly. Some pixels are missing, but not too bad. Good stuff.</p> <h2 id="postprocessing">Postprocessing</h2> <p>The final step is postprocessing. For this, morphological operations in the form of closing are performed.</p> <p>First we loop through the axial slices</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">closeHolesForEachAxialSlice</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="n">closedMask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">mask</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="sh">"</span><span class="s">uint8</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">numberOfAxialSlices</span> <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberOfAxialSlices</span><span class="p">):</span>
      <span class="n">closedSlice</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">closeHolesForEachCompoment</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
      <span class="n">closedMask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">closedSlice</span> 
    <span class="k">return</span> <span class="n">closedMask</span>
</code></pre></div></div> <p>The closing is performed for each contour/component separately. This will prevent them from growing together.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">closeHolesForEachCompoment</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">axialSlice</span><span class="p">):</span>
  <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">axialSlice</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="sh">"</span><span class="s">uint8</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">numberOfLabels</span><span class="p">,</span> <span class="n">labelImage</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">connectedComponents</span><span class="p">(</span><span class="n">axialSlice</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberOfLabels</span><span class="p">):</span>
    <span class="n">componentImage</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">labelImage</span> <span class="o">==</span> <span class="n">label</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="sh">"</span><span class="s">uint8</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">closedSlice</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">closeComponent</span><span class="p">(</span><span class="n">componentImage</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">+=</span> <span class="n">closedSlice</span>
  <span class="k">return</span> <span class="n">mask</span>    
</code></pre></div></div> <p>And finally the closing:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">closeComponent</span><span class="p">(</span><span class="n">componentImage</span><span class="p">):</span>
  <span class="n">kernel</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">getStructuringElement</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">MORPH_RECT</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>  
  <span class="k">return</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">morphologyEx</span><span class="p">(</span><span class="n">componentImage</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
</code></pre></div></div> <p>In the figure below, the closing is performed for each component separately and for all components together. You can see that the lung is indirectly connected at the top when no sperate components are used.</p> <div class="row justify-content-sm-center"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/WithComponents-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/WithComponents-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/WithComponents-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/WithComponents.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="WithComponents" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/WithoutComponents-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/WithoutComponents-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/WithoutComponents-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/WithoutComponents.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="WithoutComponents" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Separate Components (left) and no components (right). </div> <h2 id="evaluation">Evaluation</h2> <p>We have now assembled a lung segment. Remember the image we started with? You could still see the person. We reduced our region of interest in the preprocessing and found a lung, but there were artefacts, and the trachea (the tube-looking thing) was still clearly visible. Let’s see if the changes we made were successful:</p> <div class="row justify-content-center align-items-center"> <div class="col-sm mt-3 mt-md-0 d-flex justify-content-center align-items-center"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/lungSegmentation3d-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/lungSegmentation3d-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/lungSegmentation3d-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/lungSegmentation3d.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="lungSegmentation3d" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>You can see that the artefacts were successfully removed, and the trachea is no longer visible. Let us now take a look at axial slices. We will look at a good-performing example and the worst-performing example I could find.</p> <div class="row justify-content-sm-center"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/GoodCase-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/GoodCase-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/GoodCase-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/GoodCase.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="GoodCase" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/WorstCase-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/WorstCase-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/WorstCase-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/WorstCase.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="WorstCase" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Good case (left) and worst case (right). </div> <p>The slice on the left side shows almost perfect segmentation. The overlap between the predicted lung and the actual lung is displayed in green. The two black dots in the middle are the trachea and aerial ways. They were predicted by our algorithm to not be lung. Which is correct? On the right side, the worst case is displayed. A large part of the trachea is wrongly classified as a lung. Now let’s have a look at our image with two contours and see how it did:</p> <div class="row justify-content-center align-items-center"> <div class="col-sm mt-3 mt-md-0 d-flex justify-content-center align-items-center"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursResult-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursResult-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/projectImages/lungSeg/visualization/TwoContoursResult-1400.webp"></source> <img src="/assets/projectImages/lungSeg/visualization/TwoContoursResult.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="TwoContoursResult" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>The right lung is mostly classified correctly. Only two small areas of the trachea are wrongly classified. However, on the left side, it can be seen that the trachea was not removed, despite the fact that it is not connected to the lung. The solution to this problem could be retracing the lung from the bottom to the top as the trachea has been correctly removed in the outer parts, which can be seen in the 3D scan or the small evaluation in the preprocessing.</p> <h3 id="metrics">Metrics</h3> <p>Okay, we have seen a lot of slices and scans. Let us put it into numbers now. We will use the Jaccard score as a metric and evaluate it on the Vessel12 dataset. It is worth noting that the Vessel12 dataset is not specifically made for lung segmentation but rather for vessel segmentation. So the results are only to provide an idea of the performance of the algorithm. The dataset consists of twenty CT scans. Let’s see the results:</p> \[jaccard score = 0.9779 \pm 0.0103\] <p>That doesn’t look too bad!</p> <h2 id="limitations">Limitations</h2> <p>Now we will recap the assumptions we made that ensured the basic functioning, and then we will discuss the problems with the algorithm. In total, three assumptions were made:</p> <ul> <li>The width in pixels of the table is lower than 25 pixels.</li> <li>The lung is surrounded by other tissues from the left and right in sagittal slices.</li> <li>All contours in the centre slice are lung.</li> </ul> <p>If the first two conditions are not met, the algorithm will output “randomly”. If the third condition is not met, it will perform worse. A possible lifting of the first condition is the introduction of a width relative to the size of the scan. The third contition could potentially be removed by retracking the lung, as explained above.</p> <p>The current algorithm has two problems:</p> <ol> <li>The thachea in the centre slices is not perfectly removed in some scenarios.</li> <li>The contours do not precisely follow the lung contours if, for example, a vessel is at the edge of the lung.</li> </ol> <p>The origin of the first problem is the third assumption. Hence, it has the same possible solution. The second problem arises from the use of contours to create the mask rather than from the image “directly”. Kmeans has been employed to resample the image. Another less computationally heavy approach is simply the preparation step of the preprocessing—clipping and thresholding. In absence of a perfect ground truth, these approaches have been implemented but could not be evaluated. Therefore, you will not find them in this repository.</p> <h2 id="conclusion">Conclusion</h2> <p>All in all, an algorithm for lung segmentation has been successfully implemented. Nevertheless, there is still room for improvement, as described above. I hope you can take something away from this tutorial. <strong>Have a great day!</strong></p> </article> </div> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Frederik Hartmann. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>